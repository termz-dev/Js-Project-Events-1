<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/dashstyle.css">
  <title>Manage Events</title>
</head>
<body>

<section>
  <h2>Manage Your Events</h2>
  <div id="manageEventsList"></div>
</section>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { collection, getDocs, query, where, doc, deleteDoc, updateDoc } 
  from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const manageEventsList = document.getElementById("manageEventsList");
  let currentUserId = null;

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    currentUserId = user.uid;
    displayUserEvents();
  });

  async function displayUserEvents() {
    manageEventsList.innerHTML = "";

    try {
      const q = query(
        collection(db, "events"),
        where("createdBy", "==", currentUserId)
      );

      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        manageEventsList.innerHTML = "<p>You have not created any events yet.</p>";
        return;
      }

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const eventId = docSnap.id;

        const card = document.createElement("div");
        card.classList.add("event-card");

        card.innerHTML = `
          <h3>${data.title}</h3>
          <p>Location: ${data.location}</p>
          <p>Time: ${new Date(data.time).toLocaleString()}</p>
          <button class="edit-btn">Edit</button>
          <button class="delete-btn">Delete</button>
        `;

        const deleteBtn = card.querySelector(".delete-btn");
        const editBtn = card.querySelector(".edit-btn");

        deleteBtn.addEventListener("click", async () => {
          const confirmDelete = confirm("Are you sure you want to delete this event?");
          if (!confirmDelete) return;

          await deleteDoc(doc(db, "events", eventId));
          card.remove();
          alert("Event deleted successfully");
        });

        editBtn.addEventListener("click", () => {
          showEditForm(eventId, data, card);
        });

        manageEventsList.appendChild(card);
      });

    } catch (error) {
      console.error("Error loading events:", error);
    }
  }

  function showEditForm(eventId, eventData, card) {
    card.innerHTML = `
      <input type="text" id="editTitle" value="${eventData.title}">
      <input type="text" id="editLocation" value="${eventData.location}">
      <input type="datetime-local" id="editTime"
        value="${new Date(eventData.time).toISOString().slice(0,16)}">

      <button class="save-btn">Save</button>
      <button class="cancel-btn">Cancel</button>
    `;

    const saveBtn = card.querySelector(".save-btn");
    const cancelBtn = card.querySelector(".cancel-btn");

    cancelBtn.addEventListener("click", () => {
      displayUserEvents();
    });

    saveBtn.addEventListener("click", async () => {
      const updatedTitle = card.querySelector("#editTitle").value.trim();
      const updatedLocation = card.querySelector("#editLocation").value.trim();
      const updatedTime = card.querySelector("#editTime").value;

      if (!updatedTitle || !updatedLocation || !updatedTime) {
        alert("All fields are required");
        return;
      }

      try {
        await updateDoc(doc(db, "events", eventId), {
          title: updatedTitle,
          location: updatedLocation,
          time: updatedTime
        });

        alert("Event updated successfully");
        displayUserEvents();
      } catch (error) {
        console.error("Error updating event:", error);
        alert("Failed to update event");
      }
    });
  }
</script>

</body>
</html>
